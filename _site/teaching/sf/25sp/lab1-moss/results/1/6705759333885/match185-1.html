<HTML>
<HEAD>
<TITLE>./github-lab1/dslabs-cpp-RotonEvan/src/deptran/raft/service.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab1/dslabs-cpp-arkn98/src/deptran/raft/service.cc<p><PRE>

#include "../marshallable.h"
#include "service.h"
#include "server.h"

namespace janus {

RaftServiceImpl::RaftServiceImpl(TxLogServer *sched)
    : svr_((RaftServer*)sched) {
	struct timespec curr_time;
	clock_gettime(CLOCK_MONOTONIC_RAW, &curr_time);
	srand(curr_time.tv_nsec);
}

void RaftServiceImpl::HandleRequestVote(const uint64_t &term,
                                        const uint64_t &candidateId,
                                        const uint64_t &lastLogIndex,
                                        const uint64_t &lastLogTerm,
                                        uint64_t *returnTerm,
                                        bool_t *voteGranted,
                                        rrr::DeferredReply *defer) {
  /* Your code here */
  Log_debug("[site %d] Handling requestVote for site %d", svr_-&gt;site_id_, candidateId);
  svr_-&gt;mtx_.lock();

  if (term &gt; svr_-&gt;currentTerm) {
    Log_debug("[site %d] Current term changed to %d", svr_-&gt;site_id_, term);
    svr_-&gt;mtx_.unlock();
    svr_-&gt;BecomeFollower(term);
    svr_-&gt;mtx_.lock();
  }

  uint64_t ourLastLogIndex;
  uint64_t ourLastLogTerm;
  if (svr_-&gt;log.size() &gt; 0) {
    ourLastLogIndex = svr_-&gt;log.back().index;
    ourLastLogTerm = svr_-&gt;log[ourLastLogIndex].term;
  } else {
    ourLastLogIndex = -1;
    ourLastLogTerm = -1;
  }

  if (term == svr_-&gt;currentTerm
      and (svr_-&gt;votedFor == -1 or svr_-&gt;votedFor == candidateId)
      and (lastLogTerm &gt; ourLastLogTerm or (lastLogTerm == ourLastLogTerm and lastLogIndex &gt;= ourLastLogIndex))
  ) {
    Log_debug("[site %d] Granting vote for %d", svr_-&gt;site_id_, candidateId);
    *voteGranted = true;
    svr_-&gt;votedFor = candidateId;
    svr_-&gt;mtx_.unlock();
    svr_-&gt;ResetElectionTimer();
    svr_-&gt;mtx_.lock();
  } else {
    Log_debug("[site %d] Not granting vote for %d", svr_-&gt;site_id_, candidateId);
    *voteGranted = false;
  }

  // set currentTerm
  *returnTerm = svr_-&gt;currentTerm;

  svr_-&gt;mtx_.unlock();
<A NAME="1"></A><FONT color = #00FF00><A HREF="match185-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

  defer-&gt;reply();
}

void RaftServiceImpl::HandleEmptyAppendEntries(const uint64_t &term,
                                               const uint64_t &leaderId,
                                               const uint64_t &leaderCommit,
                                               uint64_t *returnTerm,
                                               bool_t *success,
</FONT>                                               rrr::DeferredReply *defer) {
//  Log_debug("[site %d] Handling heartbeat for site %d", svr_-&gt;site_id_, leaderId);
  svr_-&gt;mtx_.lock();
  *success = false;

  if (term &lt; svr_-&gt;currentTerm) {
    // received request from old term; reject it
    *returnTerm = svr_-&gt;currentTerm;
    svr_-&gt;mtx_.unlock();
    defer-&gt;reply();
    return;
  }

  // check term; if term is newer, become follower to stop any ongoing election
  if (term &gt; svr_-&gt;currentTerm) {
    Log_debug("[site %d] Current term changed to %d", svr_-&gt;site_id_, term);
    svr_-&gt;mtx_.unlock();
    svr_-&gt;BecomeFollower(term);
    svr_-&gt;mtx_.lock();
  }

  if (term == svr_-&gt;currentTerm) {
    svr_-&gt;mtx_.unlock();
    svr_-&gt;ResetElectionTimer();
    svr_-&gt;mtx_.lock();

    if (svr_-&gt;serverState != Follower) {
      svr_-&gt;mtx_.unlock();
      svr_-&gt;BecomeFollower(term);
      svr_-&gt;mtx_.lock();
    }
    *success = true;

    if (leaderCommit &gt; svr_-&gt;commitIndex) {
      Log_debug("[site %d] Updating commitIndex from %d to %d", svr_-&gt;site_id_, svr_-&gt;commitIndex, min(leaderCommit, svr_-&gt;log.size() - 1));
      svr_-&gt;commitIndex = min(leaderCommit, svr_-&gt;log.size() - 1);
    }
    svr_-&gt;mtx_.unlock();
    svr_-&gt;CheckAndApply(svr_-&gt;commitIndex);
    svr_-&gt;mtx_.lock();
  }

  *returnTerm = svr_-&gt;currentTerm;

  svr_-&gt;mtx_.unlock();
  defer-&gt;reply();
}

void RaftServiceImpl::HandleAppendEntries(const uint64_t &term,
                                          const uint64_t &leaderId,
                                          const uint64_t &prevLogIndex,
                                          const uint64_t &prevLogTerm,
                                          const MarshallDeputy& md_cmd,
                                          const uint64_t& cmdIndex,
                                          const uint64_t& cmdTerm,
                                          const uint64_t &leaderCommit,
                                          uint64_t *returnTerm,
                                          bool_t *success,
                                          rrr::DeferredReply* defer) {
  /* Your code here */
  svr_-&gt;mtx_.lock();
  *success = false;
  std::shared_ptr&lt;Marshallable&gt; cmd = const_cast&lt;MarshallDeputy&&gt;(md_cmd).sp_data_;
  Log_debug("[site %d] Handling AppendEntries from site %d, cmd: %d", svr_-&gt;site_id_, leaderId, svr_-&gt;CmdValue(cmd));

  if (term &lt; svr_-&gt;currentTerm) {
    // received request from old term; reject it
    *returnTerm = svr_-&gt;currentTerm;
    svr_-&gt;mtx_.unlock();
    defer-&gt;reply();
    return;
  }

  // check term; if term is newer, become follower to stop any ongoing election
  if (term &gt; svr_-&gt;currentTerm) {
    Log_debug("[site %d] Current term changed to %d", svr_-&gt;site_id_, term);
    svr_-&gt;mtx_.unlock();
    svr_-&gt;BecomeFollower(term);
    svr_-&gt;mtx_.lock();
  }

  if (svr_-&gt;serverState != Follower) {
    Log_debug("[site %d] Received AppendEntries from leader", svr_-&gt;site_id_);
    svr_-&gt;mtx_.unlock();
    svr_-&gt;BecomeFollower(term);
    svr_-&gt;mtx_.lock();
  }

  svr_-&gt;mtx_.unlock();
  svr_-&gt;ResetElectionTimer();
  svr_-&gt;mtx_.lock();

  if (prevLogIndex == -1
      or (prevLogIndex &lt; svr_-&gt;log.size() and prevLogTerm == svr_-&gt;log[prevLogIndex].term)) {
    *success = true;
    uint64_t insertIndex = prevLogIndex + 1;
    while (insertIndex &lt; svr_-&gt;log.size()) {
      if (svr_-&gt;log[insertIndex].term != cmdTerm)
        break;
      insertIndex++;
    }

    Log_debug("[site %d] Appending cmd %d to local log", svr_-&gt;site_id_, svr_-&gt;CmdValue(cmd));
    svr_-&gt;log.erase(svr_-&gt;log.begin() + insertIndex, svr_-&gt;log.end());
    LogEntry entry(svr_-&gt;GetMd(cmd), cmdTerm, cmdIndex);
    Log_debug("[site %d] Log length %d", svr_-&gt;site_id_, svr_-&gt;log.size());
    svr_-&gt;log.push_back(entry);
    Log_debug("[site %d] Log length %d", svr_-&gt;site_id_, svr_-&gt;log.size());

    if (leaderCommit &gt; svr_-&gt;commitIndex) {
      Log_debug("[site %d] Updating commitIndex from %d to %d", svr_-&gt;site_id_, svr_-&gt;commitIndex, min(leaderCommit, cmdIndex));
      svr_-&gt;commitIndex = min(leaderCommit, cmdIndex);
    }
    svr_-&gt;mtx_.unlock();
    svr_-&gt;CheckAndApply(svr_-&gt;commitIndex);
    svr_-&gt;mtx_.lock();
  } else {
    // our log has gaps or our log has entries not present on leader
    Log_debug("[site %d] Our log has gaps, cmd: %d", svr_-&gt;site_id_, svr_-&gt;CmdValue(cmd));
  }

<A NAME="0"></A><FONT color = #FF0000><A HREF="match185-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

  *returnTerm = svr_-&gt;currentTerm;
  svr_-&gt;mtx_.unlock();
  defer-&gt;reply();
}

void RaftServiceImpl::HandleHelloRpc(const string& req,
                                     string* res,
                                     rrr::DeferredReply* defer) {
  /* Your code here */
  Log_info("receive an rpc: %s", req.c_str());
</FONT>  *res = "world";
  defer-&gt;reply();
}

} // namespace janus;
</PRE>
</PRE>
</BODY>
</HTML>
