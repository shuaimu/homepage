<HTML>
<HEAD>
<TITLE>./github-lab1/dslabs-cpp-HOD101s/src/deptran/raft/service.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab1/dslabs-cpp-HOD101s/src/deptran/raft/service.cc<p><PRE>

#include "../marshallable.h"
#include "service.h"
#include "server.h"

namespace janus {

RaftServiceImpl::RaftServiceImpl(TxLogServer *sched)
    : svr_((RaftServer*)sched) {
	struct timespec curr_time;
	clock_gettime(CLOCK_MONOTONIC_RAW, &curr_time);
	srand(curr_time.tv_nsec);
}


void RaftServiceImpl::HandleRequestVote(const uint64_t& term,
                                        const uint64_t& candidateId,
                                        const uint64_t& lastLogIndex,
                                        const uint64_t& lastLogTerm,
                                        uint64_t *ret1,
                                        bool_t *vote_granted,
                                        rrr::DeferredReply* defer) {
  /* Your code here */
  svr_-&gt;mtx_.lock();
  int thisLastLogTerm = svr_-&gt;log[svr_-&gt;log.size()-1].term;
  int thisLastLogIndex = (svr_-&gt;log.size())-1;
  *ret1 = svr_-&gt;currentTerm;
  if (term &lt;= *ret1) { // if candidate term &lt;= voter term
    *vote_granted = false;
  } else if (lastLogTerm &lt; thisLastLogTerm) {
    *vote_granted = false;
  } else if (lastLogIndex &lt; thisLastLogIndex) {
    *vote_granted = false;
  } else {
    *vote_granted = true;
    *ret1 = term;
    svr_-&gt;currentTerm = term;
    svr_-&gt;votedFor = candidateId;
    svr_-&gt;StartElectionTimer();
  }
  svr_-&gt;mtx_.unlock();
  Log_info("%d: %d voted for %d for term %d where currentTerm is %d", *vote_granted, svr_-&gt;site_id_, candidateId, term, svr_-&gt;currentTerm);
  defer-&gt;reply();
}

void RaftServiceImpl::HandleAppendEntries(const vector&lt;MarshallDeputy&gt;& md_cmds,
                                          const vector&lt;uint64_t&gt;& cmd_terms,
                                          const vector&lt;uint64_t&gt;& cmd_indexes,
                                          const uint64_t& leaderTerm,
                                          const uint64_t& leaderId,
                                          const uint64_t& prevLogIndex,
                                          const uint64_t& prevLogTerm,
                                          const uint64_t& leaderCommitIndex,
                                          uint64_t *followerTerm,
                                          bool_t *appendSuccess,
                                          rrr::DeferredReply* defer) {
  /* Your code here */
  svr_-&gt;mtx_.lock();
  *followerTerm = svr_-&gt;currentTerm;
  *appendSuccess = false;
  Log_info("Site %d AE Leader %d where follower_term is %d follower_current_term is %d leader term is %d", svr_-&gt;site_id_, leaderId, *followerTerm, svr_-&gt;currentTerm, leaderTerm);
  if (svr_-&gt;currentTerm &gt; leaderTerm) {
    // follower term is larger 
    Log_info("AEH: site %d term %d higher than Leader(%d) %d", svr_-&gt;site_id_, svr_-&gt;currentTerm, leaderId, leaderTerm);
    *appendSuccess = false;
    *followerTerm = svr_-&gt;currentTerm;
  } else { 
    if (prevLogIndex &gt; 0 && (prevLogIndex &gt; svr_-&gt;log.size()-1 || svr_-&gt;log[prevLogIndex].term != prevLogTerm)){
      // follower log is lagging
      Log_info("AEH: site %d log is lagging compared to Leader %d", svr_-&gt;site_id_, svr_-&gt;currentTerm);
      *appendSuccess = false;
      *followerTerm = svr_-&gt;currentTerm;
    } else {
      for (int idx=0; idx&lt;cmd_terms.size(); idx++) {
        shared_ptr&lt;Marshallable&gt; cmd = const_cast&lt;MarshallDeputy&&gt;(md_cmds[idx]).sp_data_;
        svr_-&gt;InsertLogEntry(cmd, cmd_terms[idx], cmd_indexes[idx]);
        Log_info("New Entry for follower %d at index %d term %d", svr_-&gt;site_id_, svr_-&gt;log.size()-1, svr_-&gt;log[svr_-&gt;log.size()-1].term);
      }
      *appendSuccess = true;
      *followerTerm = leaderTerm;
      // svr_-&gt;currentTerm = leaderTerm;
      Log_info("AEH: site %d log replicated by Leader %d", svr_-&gt;site_id_, leaderId);
    }

    svr_-&gt;StartElectionTimer();
    Log_info("Site %d timer restart by Leaeder %d ", svr_-&gt;site_id_, leaderId);
    if (svr_-&gt;log[svr_-&gt;log.size()-1].term == leaderTerm) {
      int newCommitIndex = svr_-&gt;commitIndex;
      if (leaderCommitIndex &gt; svr_-&gt;commitIndex) {
        newCommitIndex = min(leaderCommitIndex, svr_-&gt;log.size()-1);
        for(int idx=svr_-&gt;commitIndex+1; idx&lt;=newCommitIndex; idx++) {
          Log_info("Site %d commiting index %d", svr_-&gt;site_id_, idx);
          svr_-&gt;app_next_(*svr_-&gt;log[idx].command);
        }
      }
      svr_-&gt;commitIndex = newCommitIndex;
      // Log_info("Site %d - commitIndex %d", svr_-&gt;site_id_, svr_-&gt;commitIndex);
    }

    svr_-&gt;leader_id = leaderId;
    svr_-&gt;StartElectionTimer();
    Log_info("Site %d timer restart by Leaeder %d", svr_-&gt;site_id_, leaderId);
  }
  svr_-&gt;mtx_.unlock();
  Log_info("site %d got appendEntry", svr_-&gt;site_id_);
  defer-&gt;reply();
}

void RaftServiceImpl::HandleHeartbeat(const uint64_t& leaderId,
                                        const uint64_t& leaderTerm,
                                        const uint64_t& prevLogIndex,
<A NAME="1"></A><FONT color = #00FF00><A HREF="match227-1.html#1" TARGET="1"><IMG SRC="../../../bitmaps/tm_1_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

                                        const uint64_t& prevLogTerm,
                                        const uint64_t& leaderCommitIndex,
                                        uint64_t *heartbeatTerm,
                                        bool_t *heartbeatStatus,
                                        rrr::DeferredReply* defer) {
  /* Your code here */
  svr_-&gt;mtx_.lock();
  if (svr_-&gt;currentTerm &lt;= leaderTerm) {
</FONT>    svr_-&gt;leader_id = leaderId;
    svr_-&gt;currentTerm = leaderTerm;

    // int newCommitIndex = svr_-&gt;commitIndex;
    // if (leaderCommitIndex &gt; svr_-&gt;commitIndex) {
    //   newCommitIndex = min(leaderCommitIndex, svr_-&gt;log.size()-1);
    //   for(int idx=svr_-&gt;commitIndex+1; idx&lt;=newCommitIndex; idx++) {
    //     Log_info("Site %d commiting index %d", svr_-&gt;site_id_, idx);
    //     svr_-&gt;app_next_(*svr_-&gt;log[idx].command);
    //   }
    // }
    // svr_-&gt;commitIndex = newCommitIndex;

    // Log_info("Site %d - commitIndex %d", svr_-&gt;site_id_, svr_-&gt;commitIndex);
    svr_-&gt;StartElectionTimer();
    *heartbeatStatus = true;
    *heartbeatTerm = leaderTerm;
  } else {
    *heartbeatStatus = false;
<A NAME="0"></A><FONT color = #FF0000><A HREF="match227-1.html#0" TARGET="1"><IMG SRC="../../../bitmaps/tm_0_4.gif" ALT="other" BORDER="0" ALIGN=left></A>

    *heartbeatTerm = svr_-&gt;currentTerm;
  }
  svr_-&gt;mtx_.unlock();
  defer-&gt;reply();
}

void RaftServiceImpl::HandleHelloRpc(const string& req,
                                     string* res,
                                     rrr::DeferredReply* defer) {
  /* Your code here */
  Log_info("receive an rpc: %s", req.c_str());
</FONT>  *res = "world";
  defer-&gt;reply();
}

} // namespace janus;
</PRE>
</PRE>
</BODY>
</HTML>
