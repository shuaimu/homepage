<HTML>
<HEAD>
<TITLE>./github-lab2/dslabs-cpp-ajayhegde96/src/kv/server.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab2/dslabs-cpp-ajayhegde96/src/kv/server.cc<p><PRE>
#include "../deptran/__dep__.h"
#include "server.h"
#include "../deptran/raft/server.h"
#include "client.h"

namespace janus {

static int volatile x1 =
    MarshallDeputy::RegInitializer(MarshallDeputy::CMD_MULTI_STRING,
                                     [] () -&gt; Marshallable* {
                                       return new MultiStringMarshallable;
                                     });

<A NAME="0"></A><FONT color = #FF0000><A HREF="match47-1.html#0" TARGET="1"><IMG SRC="../../../bitmaps/tm_0_2.gif" ALT="other" BORDER="0" ALIGN=left></A>

int64_t KvServer::GetNextOpId() {
  verify(sp_log_svr_);
  int64_t ret = sp_log_svr_-&gt;site_id_;
  ret = ret &lt;&lt; 32;
  ret = ret + op_id_cnt_++;
  return ret;
}

bool KvServer::IsMapUpdated(int64_t curridx)
</FONT>{
  return (curridx &lt; this-&gt;map_updated);
}


int KvServer::Put(const uint64_t& oid, 
                  const string& k,
                  const string& v) {
  /* 
  Your are recommended to use MultiStringMarshallable as the format 
  for the log entries. Here is an example how you can use it.
  auto s = make_shared&lt;MultiStringMarshallable&gt;();
  s-&gt;data_.push_back(to_string(op_id));
  s-&gt;data_.push_back("put");
  s-&gt;data_.push_back(k);
  s-&gt;data_.push_back(v);
  */
  /* your code here */
  Log_debug("[Put] Server ID: %d, Server State %d", GetRaftServer().site_id_, GetRaftServer().svr_state);
  if((GetRaftServer().svr_state != Server_State::LEADER) || (GetRaftServer().elected_leader != GetRaftServer().site_id_) || (GetRaftServer().IsDisconnected()))
    return KV_NOTLEADER;

  auto s = make_shared&lt;MultiStringMarshallable&gt;();
  s-&gt;data_.push_back(to_string(oid));
  s-&gt;data_.push_back("put");
  s-&gt;data_.push_back(k);
  s-&gt;data_.push_back(v);

  auto cmd = dynamic_pointer_cast&lt;Marshallable&gt;(s);
  int64_t curridx = this-&gt;map_updated;
  this-&gt;cmd_count += 1;

  bool result = GetRaftServer().Start(cmd, &this-&gt;index, &this-&gt;term);

  Log_debug("[Put] Index: %d, Term: %d", this-&gt;index, this-&gt;term);

  if (result == false)
    return KV_NOTLEADER;

  //auto putwait = Reactor::CreateSpEvent&lt;TimeoutEvent&gt;(KVWAIT);
  //putwait-&gt;Wait();
  Log_debug("Creating Put Event for oid: %d", s-&gt;data_[0].c_str());
  auto putwait = Reactor::CreateSpEvent&lt;IntEvent&gt;();
  this-&gt;eventmap[to_string(oid)] = putwait;
  putwait-&gt;Wait(KVWAIT);
  //this-&gt;putwait-&gt;Wait(KVWAIT);

  Log_debug("[Put] Event Status %d", putwait-&gt;status_);

<A NAME="1"></A><FONT color = #00FF00><A HREF="match47-1.html#1" TARGET="1"><IMG SRC="../../../bitmaps/tm_1_2.gif" ALT="other" BORDER="0" ALIGN=left></A>

  if((putwait-&gt;status_ == Event::DONE ) /*&& this-&gt;IsMapUpdated(curridx)*/)
  {
      return KV_SUCCESS;
  }
  
  return KV_TIMEOUT; //Any other failure

}

int KvServer::Append(const uint64_t& oid, 
                     const string& k,
                     const string& v) {
  /* your code here */

  Log_debug("[Append] Server ID: %d, Server State %d", GetRaftServer().site_id_, GetRaftServer().svr_state);
</FONT>  if((GetRaftServer().svr_state != Server_State::LEADER) || (GetRaftServer().elected_leader != GetRaftServer().site_id_) || (GetRaftServer().IsDisconnected()))
  return KV_NOTLEADER;

  auto s = make_shared&lt;MultiStringMarshallable&gt;();
  s-&gt;data_.push_back(to_string(oid));
  s-&gt;data_.push_back("append");
  s-&gt;data_.push_back(k);
  s-&gt;data_.push_back(v);

  auto cmd = dynamic_pointer_cast&lt;Marshallable&gt;(s);
  int64_t curridx = this-&gt;map_updated;
  this-&gt;cmd_count += 1;

  bool result = GetRaftServer().Start(cmd, &this-&gt;index, &this-&gt;term);

  if (result == false)
    return KV_NOTLEADER;

  //auto appendwait = Reactor::CreateSpEvent&lt;TimeoutEvent&gt;(KVWAIT);
  //appendwait-&gt;Wait();

  Log_debug("Creating Append Event for oid: %d", s-&gt;data_[0].c_str());
  auto appendwait = Reactor::CreateSpEvent&lt;IntEvent&gt;();
  this-&gt;eventmap[to_string(oid)] = appendwait;
  appendwait-&gt;Wait(KVWAIT);

  Log_debug("[Append] Event Status %d", appendwait-&gt;status_);

<A NAME="2"></A><FONT color = #0000FF><A HREF="match47-1.html#2" TARGET="1"><IMG SRC="../../../bitmaps/tm_2_2.gif" ALT="other" BORDER="0" ALIGN=left></A>

  if((appendwait-&gt;status_ == Event::DONE ) /*&& this-&gt;IsMapUpdated(curridx)*/)
  {
    return KV_SUCCESS;
  }
  
  return KV_TIMEOUT; //Any other failure

}

int KvServer::Get(const uint64_t& oid, 
                  const string& k,
                  string* v) {
  /* your code here */

  Log_debug("[Get] Server ID: %d, Server State %d", GetRaftServer().site_id_, GetRaftServer().svr_state);
</FONT>  if((GetRaftServer().svr_state != Server_State::LEADER) || (GetRaftServer().elected_leader != GetRaftServer().site_id_) || (GetRaftServer().IsDisconnected()))
    return KV_NOTLEADER;
  
  auto s = make_shared&lt;MultiStringMarshallable&gt;();
  s-&gt;data_.push_back(to_string(oid));
  s-&gt;data_.push_back("get");
  s-&gt;data_.push_back(k);
  s-&gt;data_.push_back(*v);

  auto cmd = dynamic_pointer_cast&lt;Marshallable&gt;(s);
  int64_t curridx = this-&gt;map_updated;
  this-&gt;cmd_count += 1;

  bool result = GetRaftServer().Start(cmd, &this-&gt;index, &this-&gt;term);

  if (result == false)
    return KV_NOTLEADER;

  // getwait = Reactor::CreateSpEvent&lt;TimeoutEvent&gt;(KVWAIT);
  //getwait-&gt;Wait();

  Log_debug("Creating Get Event for oid: %d", s-&gt;data_[0].c_str());
  auto getwait = Reactor::CreateSpEvent&lt;IntEvent&gt;();
  this-&gt;eventmap[to_string(oid)] = getwait;
  getwait-&gt;Wait(KVWAIT);

  Log_debug("[Get] Event Status %d", getwait-&gt;status_);
  

  if((getwait-&gt;status_ == Event::DONE ) /*&& this-&gt;IsMapUpdated(curridx)*/)
  {
    {
      *v = this-&gt;database[k];
      string s1 = *v;
      Log_debug("String Get %s", s1.c_str());
      return KV_SUCCESS;
    }
  }
  
  return KV_TIMEOUT; //Any other failure

}

void KvServer::OnNextCommand(Marshallable& m) {
  auto v = (MultiStringMarshallable*)(&m);
  /* your code here */

  Log_debug("Client Cnt %d, Op id %d for Raft Server %d",this-&gt;cli_cnt_, this-&gt;op_id_cnt_, GetRaftServer().site_id_);

  {
    if(v-&gt;data_[1] == "put")
    {
      this-&gt;database[v-&gt;data_[2]] = v-&gt;data_[3];
      Log_debug("Applied Put data to DB: Key %s, Value %s", v-&gt;data_[2].c_str(), v-&gt;data_[3].c_str());
      this-&gt;map_updated += 1;
      Log_debug("Put Event for oid: %d", v-&gt;data_[0].c_str());
      if(this-&gt;eventmap.find(v-&gt;data_[0]) != this-&gt;eventmap.end())
      {
        Log_debug("Setting Put Event for oid: %d", v-&gt;data_[0].c_str());
        this-&gt;eventmap[v-&gt;data_[0]]-&gt;Set(1);
      }
    }

    else if(v-&gt;data_[1] == "append")
    {
      if(this-&gt;database.find(v-&gt;data_[2]) != this-&gt;database.end())
        this-&gt;database[v-&gt;data_[2]] += v-&gt;data_[3];
      else
        this-&gt;database[v-&gt;data_[2]] = v-&gt;data_[3];
      
      Log_debug("Applied Append data to DB: Key %s, Value %s", v-&gt;data_[2].c_str(), this-&gt;database[v-&gt;data_[2]].c_str());
      this-&gt;map_updated += 1;
      Log_debug("Append Event for oid: %d", v-&gt;data_[0].c_str());
      if(this-&gt;eventmap.find(v-&gt;data_[0]) != this-&gt;eventmap.end())
      {
        Log_debug("Setting Append Event for oid: %d", v-&gt;data_[0].c_str());
        this-&gt;eventmap[v-&gt;data_[0]]-&gt;Set(2);
      }
    }

    else if(v-&gt;data_[1] == "get")
    {
      //pass
      this-&gt;map_updated += 1;
      Log_debug("Get Event for oid: %d", v-&gt;data_[0].c_str());
      if(this-&gt;eventmap.find(v-&gt;data_[0]) != this-&gt;eventmap.end())
      {
        Log_debug("Setting Get Event for oid: %d", v-&gt;data_[0].c_str());
        this-&gt;eventmap[v-&gt;data_[0]]-&gt;Set(3);
      }
    }
  

  }

}

shared_ptr&lt;KvClient&gt; KvServer::CreateClient() {
  /* don't change this function */
  auto cli = make_shared&lt;KvClient&gt;();
  verify(commo_ != nullptr);
  cli-&gt;commo_ = commo_;
  uint32_t id = sp_log_svr_-&gt;site_id_;
  id = id &lt;&lt; 16;
  cli-&gt;cli_id_ = id+cli_cnt_++; 
  return cli;
}

} // namespace janus;</PRE>
</PRE>
</BODY>
</HTML>
