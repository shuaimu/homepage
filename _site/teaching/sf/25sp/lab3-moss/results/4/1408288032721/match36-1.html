<HTML>
<HEAD>
<TITLE>/root/ds-labs-ta/github-lab3/shuai-teaching/dslabs-cpp-yskot1999/src/shardkv/client.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
/root/ds-labs-ta/github-lab3/shuai-teaching/dslabs-cpp-priyankaborwanker/src/shardkv/client.cc<p><PRE>
#include "../shardmaster/service.h"
#include "client.h"
#include "server.h"

namespace janus {

int ShardKvClient::Op(function&lt;int(uint32_t*)&gt; func) {
  uint64_t t1 = Time::now();
  while (true) {
    uint64_t t2 = Time::now();
    if (t2 - t1 &gt; 10000000) {
      return KV_TIMEOUT;
    }
    uint32_t ret = 0;
    int r1; 
    r1 = func(&ret);
    if (r1 == ETIMEDOUT || ret == KV_TIMEOUT) {
      leader_idx_ = (leader_idx_+1) % 5;
      return KV_TIMEOUT;
    }
    if (ret == KV_SUCCESS) {
      return KV_SUCCESS;
    }
    if (ret == KV_NOTLEADER) {
<A NAME="1"></A><FONT color = #00FF00><A HREF="match36-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_10.gif" ALT="other" BORDER="0" ALIGN=left></A>

      leader_idx_ = (leader_idx_+1) % 5;
    }
  }
}
int ShardKvClient::Put(const string& k, const string& v) {
  shardid_t k2s = Key2Shard(k);
  auto p = (ShardMasterProxy*)commo_-&gt;rpc_proxies_.at(0);
  ShardConfig sc;
  uint32_t ret1;
  p-&gt;Query(-1,&ret1,&sc);
</FONT>  //Log_info("IN k2s %d", k2s);
  for(uint64_t i = 1;i&lt;=10;i++)
  {
    //Log_info("Shard %d --&gt; Group %d",i,sc.shard_group_map_[i]);
  }
  //get group from shard id
  uint32_t group_id = sc.shard_group_map_[k2s];
  ////Log_info("group_id: %d", group_id);
  for(uint64_t i = 0;i&lt;sc.group_servers_map_[group_id].size();i++)
  {
    //Log_info("Server %d in group %d", sc.group_servers_map_[group_id][i], group_id);
  }
  siteid_t x = sc.group_servers_map_[group_id][0];
  return Op([&](uint32_t* r)-&gt;int{
    //Log_info("before calling proxy");
    return Proxy(x).Put(GetNextOpId(), k, v, r);
    //Log_info("after calling proxy");
  });
}

ShardKvProxy& ShardKvClient::Proxy(siteid_t site_id) {
  //Log_info("Before verifying commo");
  verify(commo_);
  //Log_info("After verifyn commo");
  auto p = (ShardKvProxy*)commo_-&gt;rpc_proxies_.at(site_id);
  if(p)
  {
    //Log_info("p is not null");

  }
<A NAME="2"></A><FONT color = #0000FF><A HREF="match36-0.html#2" TARGET="0"><IMG SRC="../../../bitmaps/tm_2_9.gif" ALT="other" BORDER="0" ALIGN=left></A>

  return *p; 
}

int ShardKvClient::Append(const string& k, const string& v) {
  shardid_t k2s = Key2Shard(k);
  auto p = (ShardMasterProxy*)commo_-&gt;rpc_proxies_.at(0);
  ShardConfig sc;
  uint32_t ret1;
  p-&gt;Query(-1,&ret1,&sc);
</FONT>
  //get group from shard id
  uint64_t group_id = sc.shard_group_map_[k2s];
  return Op([&](uint32_t* r)-&gt;int{
<A NAME="0"></A><FONT color = #FF0000><A HREF="match36-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_11.gif" ALT="other" BORDER="0" ALIGN=left></A>

    return Proxy(sc.group_servers_map_[group_id][0]).Append(GetNextOpId(), k, v, r);
  });
}

int ShardKvClient::Get(const string& k, string* v) {
  shardid_t k2s = Key2Shard(k);
  auto p = (ShardMasterProxy*)commo_-&gt;rpc_proxies_.at(0);
  ShardConfig sc;
  uint32_t ret1;
  p-&gt;Query(-1,&ret1,&sc);
</FONT>  //get group from shard id
  uint64_t group_id = sc.shard_group_map_[k2s];
  return Op([&](uint32_t* r)-&gt;int{
    return Proxy(sc.group_servers_map_[group_id][0]).Get(GetNextOpId(), k, r, v);
  });
}

} // namesapce janus;</PRE>
</PRE>
</BODY>
</HTML>
