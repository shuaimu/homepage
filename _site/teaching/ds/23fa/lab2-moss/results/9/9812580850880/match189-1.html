<HTML>
<HEAD>
<TITLE>./github-lab2/dslabs-cpp-bnithish/src/kv/server.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab2/dslabs-cpp-jithin1/src/kv/server.cc<p><PRE>
#include "../deptran/__dep__.h"
#include "server.h"
#include "../deptran/raft/server.h"
#include "client.h"

namespace janus {

static int volatile x1 =
    MarshallDeputy::RegInitializer(MarshallDeputy::CMD_MULTI_STRING,
                                     [] () -&gt; Marshallable* {
                                       return new MultiStringMarshallable;
                                     });

int64_t KvServer::GetNextOpId() {
  verify(sp_log_svr_);
  int64_t ret = sp_log_svr_-&gt;site_id_;
  ret = ret &lt;&lt; 32;
  ret = ret + op_id_cnt_++; 
  return ret;
}


/*
Thread must not be blocked
*/

int KvServer::Put(const uint64_t& oid, 
                  const string& k,
                  const string& v) {


  const auto cmd = make_shared&lt;MultiStringMarshallable&gt;();
  cmd-&gt;data_.push_back(to_string(oid));
<A NAME="0"></A><FONT color = #FF0000><A HREF="match189-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

  cmd-&gt;data_.push_back("put");
  cmd-&gt;data_.push_back(k);
  cmd-&gt;data_.push_back(v);
  /* your code here */

  auto cmd_m = dynamic_pointer_cast&lt;Marshallable&gt;(cmd);
  uint64_t index = -1, term = -1;
</FONT>
  if(GetRaftServer().node_state != 1)
    return KV_NOTLEADER;

  Log_info("After calling Start, the site_Id is %d and the command id: %s and command is Put", GetRaftServer().site_id_, cmd-&gt;data_[0].c_str());

  long timeout = 3000000;
  long start = Time::now();

  GetRaftServer().Start(cmd_m, &index, &term);

  while(Time::now() - start &lt; timeout){
    Coroutine::Sleep(500000);

    if(completed_commands.find(cmd-&gt;data_[0]) != completed_commands.end())
      return KV_SUCCESS;
  }

  
  Log_info("The site_Id is %d and the command id: %d and command is Put and time is %d", GetRaftServer().site_id_, oid,Time::now() - start);

  return KV_TIMEOUT;
}

/*
Thread must not be blocked
*/
int KvServer::Append(const uint64_t& oid, 
                     const string& k,
                     const string& v) {
  /* your code here */

  const auto cmd = make_shared&lt;MultiStringMarshallable&gt;();
  cmd-&gt;data_.push_back(to_string(oid));
<A NAME="1"></A><FONT color = #00FF00><A HREF="match189-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_3.gif" ALT="other" BORDER="0" ALIGN=left></A>

  cmd-&gt;data_.push_back("append");
  cmd-&gt;data_.push_back(k);
  cmd-&gt;data_.push_back(v);
  /* your code here */

  auto cmd_m = dynamic_pointer_cast&lt;Marshallable&gt;(cmd);
  uint64_t index = -1, term = -1;
</FONT>   
  if(GetRaftServer().node_state != 1)
    return KV_NOTLEADER;

  Log_info("Before calling Start, the site_Id is %d and the command id: %s and command is Append", GetRaftServer().site_id_, cmd-&gt;data_[0].c_str());

  long timeout = 3000000;
  long start = Time::now();

  GetRaftServer().Start(cmd_m, &index, &term);

  while(Time::now() - start &lt; timeout){
    Coroutine::Sleep(500000);

    if(completed_commands.find(cmd-&gt;data_[0]) != completed_commands.end())
      return KV_SUCCESS;
  }

  Log_info("The site_Id is %d and the command id: %s and command is Append the time is %d", GetRaftServer().site_id_, cmd-&gt;data_[0].c_str(), Time::now() - start);

  return KV_TIMEOUT;
  
}

/*
Thread must not be blocked
*/

int KvServer::Get(const uint64_t& oid, 
                  const string& k,
                  string* v) {
  /* your code here */

  if(GetRaftServer().node_state != 1)
    return KV_NOTLEADER;

  const auto cmd = make_shared&lt;MultiStringMarshallable&gt;();
  cmd-&gt;data_.push_back(to_string(oid));
  cmd-&gt;data_.push_back("get");
  cmd-&gt;data_.push_back(k);
  cmd-&gt;data_.push_back("dummy value");
  /* your code here */

  auto cmd_m = dynamic_pointer_cast&lt;Marshallable&gt;(cmd);
  uint64_t index = -1, term = -1;
   
  if(GetRaftServer().node_state != 1)
    return KV_NOTLEADER;

  GetRaftServer().Start(cmd_m, &index, &term);

  Coroutine::Sleep(600000);

  Log_info("The site_Id is %d and the command id: %s and command is Get", GetRaftServer().site_id_, cmd-&gt;data_[0].c_str());

  if(completed_commands.find(cmd-&gt;data_[0]) == completed_commands.end())
    return KV_TIMEOUT;

  *v = key_value_database[k];
  return KV_SUCCESS;
}

void KvServer::OnNextCommand(Marshallable& m) {
  auto v = (MultiStringMarshallable*)(&m);
  /* your code here */
  
  vector&lt;string&gt; data = v-&gt;data_;
  string command = data[0];
  string key = data[2];
  string value = data[3];

  if(data[1].compare("put") == 0){
    key_value_database[key] = value;
  }
  else if(data[1].compare("append") == 0){
    if(key_value_database.find(key) != key_value_database.end()){
      string cur_value = key_value_database[key];
      cur_value.append(value);
      key_value_database[key] = cur_value;
    }
    else{    
      key_value_database[key] = value;
    }
  }

  //TODO: Handle the bug for get commands
  completed_commands.insert(command);   

  for (auto i : key_value_database)
    Log_info("The content of the map for Raft peer: %d for key :%s and for value: %s", GetRaftServer().site_id_, i.first.c_str(), i.second.c_str());
}

shared_ptr&lt;KvClient&gt; KvServer::CreateClient() {
  /* don't change this function */
  auto cli = make_shared&lt;KvClient&gt;();
  verify(commo_ != nullptr);
  cli-&gt;commo_ = commo_;
  uint32_t id = sp_log_svr_-&gt;site_id_;
  id = id &lt;&lt; 16;
  cli-&gt;cli_id_ = id+cli_cnt_++; 
  return cli;
}

} // namespace janus;</PRE>
</PRE>
</BODY>
</HTML>
