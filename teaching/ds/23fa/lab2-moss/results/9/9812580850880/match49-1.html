<HTML>
<HEAD>
<TITLE>./github-lab2/dslabs-cpp-ajayhegde96/src/kv/server.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab2/dslabs-cpp-Sethu98-1/src/kv/server.cc<p><PRE>
#include "../deptran/__dep__.h"
#include "server.h"
#include "../deptran/raft/server.h"
#include "client.h"

#define SLEEP_TIME_MILLIS 2000
// SUBMISSION 2

namespace janus {

static int volatile x1 =
        MarshallDeputy::RegInitializer(MarshallDeputy::CMD_MULTI_STRING,
                                       []() -&gt; Marshallable * {
                                           return new MultiStringMarshallable;
                                       });

<A NAME="0"></A><FONT color = #FF0000><A HREF="match49-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_5.gif" ALT="other" BORDER="0" ALIGN=left></A>

int64_t KvServer::GetNextOpId() {
    verify(sp_log_svr_);
    int64_t ret = sp_log_svr_-&gt;site_id_;
    ret = ret &lt;&lt; 32;
    ret = ret + op_id_cnt_++;
    return ret;
}

string KvServer::get_expected_value(std::string operation, std::string key, std::string value) {
</FONT>    if (operation == "put") {
        return value;
    } else { // append
        return kv_.find(key) == kv_.end() ? value : kv_[key] + value;
    }
}

int KvServer::handle_operation(const uint64_t &oid,
                               const std::string &key,
                               const std::string &value,
                               const std::string operation) {
    auto &svr = GetRaftServer();
    if (!svr.is_leader()) return KV_NOTLEADER;

    auto entry = make_shared&lt;MultiStringMarshallable&gt;();
    string oid_str = to_string(oid);

    entry-&gt;data_.push_back(oid_str);
    entry-&gt;data_.push_back(operation);
    entry-&gt;data_.push_back(key);
    entry-&gt;data_.push_back(value);

    index_t index;
    term_t term;
    auto cmd = dynamic_pointer_cast&lt;Marshallable&gt;(entry);

    svr.Start(cmd, &index, &term);

    auto event = Reactor::CreateSpEvent&lt;IntEvent&gt;();
    processed_ops_[oid_str] = event;
    event-&gt;Wait(SLEEP_TIME_MILLIS * 1000);

<A NAME="1"></A><FONT color = #00FF00><A HREF="match49-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_5.gif" ALT="other" BORDER="0" ALIGN=left></A>

    if (event-&gt;status_ == Event::TIMEOUT) {
        // Timed out
        return KV_TIMEOUT;
    }

    return KV_SUCCESS;
}

int KvServer::Put(const uint64_t &oid,
                  const string &k,
                  const string &v) {
//    return handle_operation(oid, k, v, "put");
    auto resp = handle_operation(oid, k, v, "put");
</FONT>    Log_debug("Put response %d at %d", resp, GetRaftServer().loc_id_);

    return resp;
}

int KvServer::Append(const uint64_t &oid,
                     const string &k,
                     const string &v) {
    //    return handle_operation(oid, k, v, "append");
    auto resp = handle_operation(oid, k, v, "append");
    Log_debug("Append response %d at %d", resp, GetRaftServer().loc_id_);

    return resp;
}

int KvServer::Get(const uint64_t &oid,
                  const string &k,
                  string *v) {
    auto resp = handle_operation(oid, k, "", "get");
    Log_debug("Get response %d at %d", resp, GetRaftServer().loc_id_);

    if (resp == KV_SUCCESS) {
        *v = kv_[k];
        return KV_SUCCESS;
    }

    return resp;
}

void KvServer::OnNextCommand(Marshallable &m) {
    auto cmd_vec = ((MultiStringMarshallable *) (&m))-&gt;data_;
    auto oid_str = cmd_vec[0], operation = cmd_vec[1], key = cmd_vec[2], value = cmd_vec[3];

    if (operation == "put" OR operation == "append") {
        // Set value
        kv_[key] = get_expected_value(operation, key, value);
    }

    if (processed_ops_.find(oid_str) != processed_ops_.end()) {
        // If server is the one that processed the operation, mark it as complete
<A NAME="2"></A><FONT color = #0000FF><A HREF="match49-0.html#2" TARGET="0"><IMG SRC="../../../bitmaps/tm_2_5.gif" ALT="other" BORDER="0" ALIGN=left></A>

        processed_ops_[oid_str]-&gt;Set(1);
    }
}

shared_ptr &lt;KvClient&gt; KvServer::CreateClient() {
    /* don't change this function */
    auto cli = make_shared&lt;KvClient&gt;();
    verify(commo_ != nullptr);
    cli-&gt;commo_ = commo_;
</FONT>    uint32_t id = sp_log_svr_-&gt;site_id_;
    id = id &lt;&lt; 16;
    cli-&gt;cli_id_ = id + cli_cnt_++;
    return cli;
}

} // namespace janus;</PRE>
</PRE>
</BODY>
</HTML>
