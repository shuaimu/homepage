<HTML>
<HEAD>
<TITLE>/root/ds-labs-ta/github-lab3/shuai-teaching/dslabs-cpp-4molybdenum2/src/shardkv/client.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
/root/ds-labs-ta/github-lab3/shuai-teaching/dslabs-cpp-mainak9830/src/shardkv/client.cc<p><PRE>


#include "client.h"
#include "server.h"

namespace janus {

int ShardKvClient::Op(function&lt;int(uint32_t*)&gt; func) {
  uint64_t t1 = Time::now();
  while (true) {
    uint64_t t2 = Time::now();
    if (t2 - t1 &gt; 10000000) {
      return KV_TIMEOUT;
    }
    uint32_t ret = 0;
    int r1; 
    r1 = func(&ret);
    if (r1 == ETIMEDOUT || ret == KV_TIMEOUT) {
      leader_idx_ = (leader_idx_+1) % 5;
      return KV_TIMEOUT;
    }
    if (ret == KV_SUCCESS) {
      return KV_SUCCESS;
    }
    if (ret == KV_NOTLEADER) {
      leader_idx_ = (leader_idx_+1) % 5;
    }
  }

}

int ShardKvClient::Put(const string& k, const string& v) {
  // cout &lt;&lt; " I am here at put client.cc" &lt;&lt; endl;
  auto shardId = Key2Shard(k)+1;

  
  auto cli = make_shared&lt;ShardMasterClient&gt;();
  cli-&gt;commo_ = new Communicator();

  // // // cli-&gt;commo_ = sp_log_svr_-&gt;commo_;
  
  ShardConfig config;
  cli-&gt;Query(-1, &config);

  // cout &lt;&lt; "hey i am here at the shardkv config " &lt;&lt; config.group_servers_map_[2] &lt;&lt; endl;
  // cli-&gt;Query(-1, &config);

  
  // cli-&gt;commo_-&gt;Query(-1);

  auto shardGroupIDLoc = config.shard_group_map_[shardId];
  // vector&lt;
  vector&lt;int&gt; site_ids;

  for (auto partitionkv : config.group_servers_map_[shardGroupIDLoc])
  {
    // cout &lt;&lt; " site_id of raft server " &lt;&lt; partitionkv &lt;&lt; endl;
    site_ids.push_back(partitionkv);

    
  }

  // for (auto partitionkv : partitionProxy)
  // {
  //   site_ids.push_back(partitionkv.first);

  //   cout &lt;&lt; partitionkv.first &lt;&lt; " is the key with value " &lt;&lt; partitionkv.second &lt;&lt; endl;
  // }
  
<A NAME="0"></A><FONT color = #FF0000><A HREF="match210-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_9.gif" ALT="other" BORDER="0" ALIGN=left></A>

  return Op([&](uint32_t* r)-&gt;int{
    return Proxy(site_ids[leader_idx_]).Put(GetNextOpId(), k, v, r);
  });
}

ShardKvProxy& ShardKvClient::Proxy(siteid_t site_id) {
  verify(commo_);
  auto p = (ShardKvProxy*)commo_-&gt;rpc_proxies_.at(site_id);
</FONT>  return *p; 
}

int ShardKvClient::Append(const string& k, const string& v) {
  auto shardId = Key2Shard(k) + 1;

  auto cli = make_shared&lt;ShardMasterClient&gt;();
  cli-&gt;commo_ = new Communicator();

  // // // cli-&gt;commo_ = sp_log_svr_-&gt;commo_;

  ShardConfig config;
  cli-&gt;Query(-1, &config);

  // cout &lt;&lt; "hey i am here at the shardkv config " &lt;&lt; config.group_servers_map_[2] &lt;&lt; endl;
  // cli-&gt;Query(-1, &config);

  // cli-&gt;commo_-&gt;Query(-1);

  auto shardGroupIDLoc = config.shard_group_map_[shardId];
  // vector&lt;
  vector&lt;int&gt; site_ids;

  for (auto partitionkv : config.group_servers_map_[shardGroupIDLoc])
  {
    // cout &lt;&lt; " site_id of raft server " &lt;&lt; partitionkv &lt;&lt; endl;
    site_ids.push_back(partitionkv);
  }
<A NAME="1"></A><FONT color = #00FF00><A HREF="match210-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_9.gif" ALT="other" BORDER="0" ALIGN=left></A>

  return Op([&](uint32_t* r)-&gt;int{
    return Proxy(site_ids[leader_idx_]).Append(GetNextOpId(), k, v, r);
  });
}

int ShardKvClient::Get(const string& k, string* v) {

  // cout &lt;&lt; " I am here at put client.cc" &lt;&lt; endl;
  auto shardId = Key2Shard(k) + 1;
</FONT>
  auto cli = make_shared&lt;ShardMasterClient&gt;();
  cli-&gt;commo_ = new Communicator();

  // // // cli-&gt;commo_ = sp_log_svr_-&gt;commo_;

  ShardConfig config;
  cli-&gt;Query(-1, &config);

  vector&lt;int&gt; site_ids;
  auto shardGroupIDLoc = config.shard_group_map_[shardId];
  for (auto partitionkv : config.group_servers_map_[shardGroupIDLoc])
  {
    // cout &lt;&lt; " site_id of raft server " &lt;&lt; partitionkv &lt;&lt; endl;
    site_ids.push_back(partitionkv);
  }
  return Op([&](uint32_t* r)-&gt;int{
    return Proxy(site_ids[leader_idx_]).Get(GetNextOpId(), k, r, v);
  });
}

} // namesapce janus;</PRE>
</PRE>
</BODY>
</HTML>
