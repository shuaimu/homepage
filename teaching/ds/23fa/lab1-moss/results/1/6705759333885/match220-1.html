<HTML>
<HEAD>
<TITLE>./github-lab1/dslabs-cpp-SwethaSrilakshmi/src/deptran/raft/service.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab1/dslabs-cpp-priyankaborwanker/src/deptran/raft/service.cc<p><PRE>

#include "../marshallable.h"
#include "service.h"
#include "server.h"

namespace janus {

RaftServiceImpl::RaftServiceImpl(TxLogServer *sched)
    : svr_((RaftServer*)sched) {
	struct timespec curr_time;
	clock_gettime(CLOCK_MONOTONIC_RAW, &curr_time);
	srand(curr_time.tv_nsec);
}



void RaftServiceImpl::HandleRequestVote(const uint64_t& last_log_index,
                                        const uint64_t& last_log_term,
                                        const uint64_t& term,
                                        const uint64_t& candidateId,
                                        uint64_t *ret1,
                                        bool_t *vote_granted,
                                        rrr::DeferredReply* defer) {
  /* Your code here */
  Log_info("\n Request reached from %d to %d, candidate term: %d, voter term: %d, voter voted for is: %d \n", candidateId, svr_-&gt;loc_id_, term, svr_-&gt;currTerm, svr_-&gt;votedFor);
  if(term &lt; svr_-&gt;currTerm)
  {
    *vote_granted = false;
    *ret1 = svr_-&gt;currTerm;
  }
  else{
    svr_-&gt;timeout = false;
    if(term &gt; svr_-&gt;currTerm )
    {
      svr_-&gt;is_leader = false;
      svr_-&gt;currTerm = term;
      svr_-&gt;votedFor = -1;
    }
    *vote_granted = false;
    *ret1 = svr_-&gt;currTerm;
    uint64_t lli = 0;//lastlogindex
    uint64_t llt = 0;//lastlogterm
    if(svr_-&gt;v_term.size()&gt;0)
    {
      lli = svr_-&gt;v_term.size();
      llt = svr_-&gt;v_term[svr_-&gt;v_term.size()-1];
    }
    Log_info("last log index(candidates) = %d lli (voter) = %d last log term(candidates) = %d, llt (voter) = %d", last_log_index, lli, last_log_term, llt);
<A NAME="0"></A><FONT color = #FF0000><A HREF="match220-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_2.gif" ALT="other" BORDER="0" ALIGN=left></A>

    if((svr_-&gt;votedFor == -1 || svr_-&gt;votedFor == candidateId) && (last_log_term &gt; llt || (last_log_term == llt && last_log_index &gt;= lli)))
    {
      svr_-&gt;votedFor = candidateId;
      *vote_granted = true;
      svr_-&gt;is_leader = false;
</FONT>      svr_-&gt;currTerm = term;
      *ret1 = svr_-&gt;currTerm;
      Log_info("Server %d voted for candidate %d",svr_-&gt;loc_id_,candidateId);
    }
  }
  //Log_info("In Handle RV, set to %d", svr_-&gt;currTerm);
  //Log_info("No crash yet, before defer reply, sent from %d to %d", candidateId, svr_-&gt;loc_id_);
<A NAME="1"></A><FONT color = #00FF00><A HREF="match220-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_2.gif" ALT="other" BORDER="0" ALIGN=left></A>

  defer-&gt;reply();
  //Log_info("After defer reply\n");
}

void RaftServiceImpl::HandleHeartbeat(const uint64_t& term,
                                      const uint64_t& candidateId,
                                      const uint64_t& last_applied,
                                      uint64_t* ret1,
                                      rrr::DeferredReply* defer) {
</FONT>  /* Your code here */
  //Log_info("In HandleHeartbeat: Recieved heartbeat from %d to %d", candidateId, svr_-&gt;loc_id_);
  Log_info("Heartbeat reached to %d", svr_-&gt;loc_id_);
  //std::shared_ptr&lt;Marshallable&gt; cmd = const_cast&lt;MarshallDeputy&&gt;(md_cmd).sp_data_;
  svr_-&gt;timeout = false;
  //svr_-&gt;votedFor = candidateId;
  if(svr_-&gt;currTerm &lt; term)
  {
    svr_-&gt;votedFor = -1;
    svr_-&gt;currTerm = term;
    svr_-&gt;is_leader = false;
  }
  if(last_applied&gt;svr_-&gt;last_applied)
  {
    for(uint64_t i = svr_-&gt;last_applied;i &lt; min(svr_-&gt;commit_index, last_applied); i++)
    {
      ///Log_info("Size of v_command: %d", svr_-&gt;v_command.size());
      //Log_info("--1 before applied to state machine - follower --");
      svr_-&gt;app_next_(*(svr_-&gt;v_command[i]));
      (svr_-&gt;last_applied)++;
      Log_info("--after applied to state machine of %d commit index: %d heartbeat", svr_-&gt;loc_id_, i);

      //Log_info("--Applied to state machine - follower --");
    }

  }
  *ret1 = svr_-&gt;currTerm;
  //Log_info("In Handle HeartbeatTerm, set to %d", *ret1);
  defer-&gt;reply();
  //Log_info("after defer reply");
}

void RaftServiceImpl::HandleAppendEntries(const uint64_t& prev_log_index,
                                          const uint64_t& prev_log_term,
                                          const uint64_t& term,
                                          const uint64_t& last_applied,
                                          const uint64_t& corresponding_term,
                                          const vector&lt;MarshallDeputy&gt; &cmd,
                                          const vector&lt;uint64_t&gt;& v_term,
                                          bool_t *followerAppendOK,
                                          uint64_t* follower_next_index,
                                          uint64_t* ret1,
                                          rrr::DeferredReply* defer) {
  /* Your code here */
  //Log_info("Append Entries reached to %d", svr_-&gt;loc_id_);
  //std::shared_ptr&lt;Marshallable&gt; cmd = const_cast&lt;MarshallDeputy&&gt;(md).sp_data_;
  svr_-&gt;timeout = false;
  //Log_info("AppendEntries reached to %d, prev_log_index: %d, prev_log_term = %d", svr_-&gt;loc_id_,svr_-&gt;commitIndex, svr_-&gt; prev_log_term);
  //svr_-&gt;votedFor = candidateId;
  if(svr_-&gt;currTerm &lt; term)
  {
    svr_-&gt;votedFor = -1;
    svr_-&gt;currTerm = term;
    svr_-&gt;is_leader = false;
  }
  *followerAppendOK = false;
  svr_-&gt;commit_index = svr_-&gt;v_term.size();
  svr_-&gt;prev_log_term = svr_-&gt;v_term.size()&gt;0 ? svr_-&gt;v_term[svr_-&gt;v_term.size()-1] : 0;
  Log_info("Leader array size: %d", cmd.size());
  if(term&gt;=svr_-&gt;currTerm)
  {
    if(prev_log_index == svr_-&gt;commit_index && prev_log_term == svr_-&gt;prev_log_term)
    {
      for(uint64_t i = prev_log_index; i&lt;cmd.size();i++)
      {
        (svr_-&gt;commit_index)++;
        std::shared_ptr&lt;Marshallable&gt; cmd1 = const_cast&lt;MarshallDeputy&&gt;(cmd[i]).sp_data_;
        svr_-&gt;v_command.push_back(cmd1);
        svr_-&gt;v_deputy.push_back(cmd[i]);
        svr_-&gt;v_term.push_back(v_term[i]);
        Log_info("CASE 1: server %d Commit Index %d prev_log_term: %d", svr_-&gt;loc_id_, svr_-&gt;commit_index, svr_-&gt;prev_log_term);
        *followerAppendOK = true;
      }
    }
    else if(svr_-&gt;commit_index &gt;= prev_log_index)
    {
      Log_info("CASE 2:server %d Recieved prev log index: %d prev log index(commit index): %d Recieved term: %d Server term: %d", svr_-&gt;loc_id_, prev_log_index , svr_-&gt;commit_index, term, svr_-&gt;prev_log_term);
      while(svr_-&gt;v_term.size()&gt;0 &&  svr_-&gt;commit_index &gt; prev_log_index)
      {
        Log_info("Server %d removing entry with commit index: %d",svr_-&gt;loc_id_, svr_-&gt;commit_index);
        if(svr_-&gt;v_term.size()&gt;0)
        {
          svr_-&gt;v_deputy.pop_back();
          svr_-&gt;v_term.pop_back();
          svr_-&gt;v_command.pop_back();
        }
        svr_-&gt;commit_index = svr_-&gt;v_term.size();
        if(svr_-&gt;commit_index&gt;1)
        {
          svr_-&gt;prev_log_term = svr_-&gt;v_term[svr_-&gt;commit_index-1];
        }
        else{
          svr_-&gt;prev_log_term = 0;
        }
      }
      for(int j = svr_-&gt;commit_index; j&gt;=0 && svr_-&gt;v_term[j]!=v_term[j];j--)
      {
        Log_info("Server %d removing entry with commit index: %d",svr_-&gt;loc_id_, svr_-&gt;commit_index);
        if(svr_-&gt;v_term.size()&gt;0)
        {
          svr_-&gt;v_deputy.pop_back();
          svr_-&gt;v_term.pop_back();
          svr_-&gt;v_command.pop_back();
        }
        svr_-&gt;commit_index = svr_-&gt;v_term.size();
        if(svr_-&gt;commit_index&gt;1)
        {
          svr_-&gt;prev_log_term = svr_-&gt;v_term[svr_-&gt;commit_index-1];
        }
        else{
          svr_-&gt;prev_log_term = 0;
        } 
      }
      for(uint64_t i = svr_-&gt;commit_index; i&lt;cmd.size();i++)
      {
        (svr_-&gt;commit_index)++;
        svr_-&gt;prev_log_term = v_term[i];
        std::shared_ptr&lt;Marshallable&gt; cmd1 = const_cast&lt;MarshallDeputy&&gt;(cmd[i]).sp_data_;
        svr_-&gt;v_command.push_back(cmd1);
        svr_-&gt;v_deputy.push_back(cmd[i]);
        svr_-&gt;v_term.push_back(v_term[i]);
        Log_info("CASE 1: server %d Co mmit Index %d prev_log_term: %d", svr_-&gt;loc_id_, svr_-&gt;commit_index, svr_-&gt;prev_log_term);
        *followerAppendOK = true;
      }
    }
    else{
      Log_info("CASE 3: server %d entries missing, waiting for another lesser commit index", svr_-&gt;loc_id_);
    }
    
    if(last_applied&gt;svr_-&gt;last_applied)
    {

      for(uint64_t i = svr_-&gt;last_applied;i&lt;min(last_applied, svr_-&gt;commit_index);i++)
      {
        //Log_info("--before applied to state machine - follower --");
        svr_-&gt;app_next_(*(svr_-&gt;v_command[i]));
        (svr_-&gt;last_applied)++;
        Log_info("--after applied to state machine of %d commit index: %d heartbeat", svr_-&gt;loc_id_, i);

      }
    }
  }
  svr_-&gt;prev_log_term = svr_-&gt;v_term[svr_-&gt;v_term.size()-1];
  *follower_next_index = (svr_-&gt;v_term.size())+1;
  Log_info("Returning follower next  index as service.cc: %d", *follower_next_index);
  *ret1 = svr_-&gt;currTerm;
  svr_-&gt;commit_index = svr_-&gt;v_term.size();
  Log_info("Returning term: %d", *ret1);
  defer-&gt;reply();
}

void RaftServiceImpl::HandleHelloRpc(const string& req,
                                     string* res,
                                     rrr::DeferredReply* defer) {
  /* Your code here */
  Log_info("receive an rpc: %s", req.c_str());
  *res = "world";

  defer-&gt;reply();
}

} // namespace janus;
</PRE>
</PRE>
</BODY>
</HTML>
