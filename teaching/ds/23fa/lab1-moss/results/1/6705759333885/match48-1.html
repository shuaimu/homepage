<HTML>
<HEAD>
<TITLE>./github-lab1/dslabs-cpp-JayaramKrovvidi/src/deptran/raft/service.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab1/dslabs-cpp-iGN5117/src/deptran/raft/service.cc<p><PRE>

#include "../marshallable.h"
#include "service.h"
#include "server.h"

namespace janus {

RaftServiceImpl::RaftServiceImpl(TxLogServer *sched)
    : svr_((RaftServer*)sched) {
	struct timespec curr_time;
	clock_gettime(CLOCK_MONOTONIC_RAW, &curr_time);
	srand(curr_time.tv_nsec);
}


void RaftServiceImpl::HandleRequestVote(const uint64_t& term,
                                        const uint64_t& candidateId,
                                        const uint64_t& lastLogIndex,
                                        const uint64_t& lastLogTerm,
                                        uint64_t *currentTerm,
                                        bool_t *voteGranted,
                                        rrr::DeferredReply* defer) {
  /* Your code here */
<A NAME="0"></A><FONT color = #FF0000><A HREF="match48-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_15.gif" ALT="other" BORDER="0" ALIGN=left></A>

  tuple&lt;int, bool_t&gt; returnValues = svr_-&gt;HandleRequestVote(term, candidateId, lastLogIndex, lastLogTerm);
  *currentTerm = get&lt;0&gt;(returnValues);
  *voteGranted = get&lt;1&gt;(returnValues);
  defer-&gt;reply();
}

void RaftServiceImpl::HandleHeartbeat(const uint64_t& term,
                                      const uint64_t& leaderId,
                                      const uint64_t& prevLogIndex,
</FONT>                                      const uint64_t& prevLogTerm,
                                      const uint64_t& leaderCommitIndex,
                                      bool_t* followerAppendOK,
                                      uint64_t* currentTerm,
                                      rrr::DeferredReply* defer) {
  tuple&lt;uint64_t, bool_t&gt; returnValue = svr_-&gt;HandleHeartbeat(term, leaderId, prevLogIndex, prevLogTerm, leaderCommitIndex);
  *currentTerm = get&lt;0&gt;(returnValue);
  *followerAppendOK = get&lt;1&gt;(returnValue);
  defer-&gt;reply();                                  
}

void RaftServiceImpl::HandleAppendEntries(const vector&lt;MarshallDeputy&gt;& md_cmd,
                                      const uint64_t& term,
                                      const uint64_t& leaderId,
                                      const uint64_t& prevLogIndex,
                                      const uint64_t& prevLogTerm,
                                      const uint64_t& leaderCommitIndex,
                                      bool_t* followerAppendOK,
                                      uint64_t* currentTerm,
                                      rrr::DeferredReply* defer) {
  /* Your code here */
  vector&lt;shared_ptr&lt;Marshallable&gt;&gt; cmdVector = {};
  for (MarshallDeputy md : md_cmd) {
    cmdVector.push_back(const_cast&lt;MarshallDeputy&&gt;(md).sp_data_);
  }
  tuple&lt;uint64_t, bool_t&gt; returnValue = svr_-&gt;HandleAppendEntries(term, leaderId, prevLogIndex, prevLogTerm, cmdVector, leaderCommitIndex);
<A NAME="1"></A><FONT color = #00FF00><A HREF="match48-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_10.gif" ALT="other" BORDER="0" ALIGN=left></A>

  *followerAppendOK = get&lt;1&gt;(returnValue);
  *currentTerm = get&lt;0&gt;(returnValue);
  //Log_info("Server %i replied %s and %i to leader %i", svr_-&gt;loc_id_, *followerAppendOK ? "true" : "false", *currentTerm, leaderId);
  defer-&gt;reply();
}

void RaftServiceImpl::HandleHelloRpc(const string& req,
                                     bool_t* res,
                                     rrr::DeferredReply* defer) {
  /* Your code here */
  Log_info("receive an rpc: %s", req.c_str());
</FONT>  *res = true;
  defer-&gt;reply();
}

} // namespace janus;
</PRE>
</PRE>
</BODY>
</HTML>
