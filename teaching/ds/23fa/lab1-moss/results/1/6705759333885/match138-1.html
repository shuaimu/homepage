<HTML>
<HEAD>
<TITLE>./github-lab1/dslabs-cpp-demonicode/src/deptran/raft/service.cc</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab1/dslabs-cpp-karthikbhata97/src/deptran/raft/service.cc<p><PRE>

#include "../marshallable.h"
#include "service.h"
#include "server.h"

namespace janus {

RaftServiceImpl::RaftServiceImpl(TxLogServer *sched)
    : svr_((RaftServer*)sched) {
	struct timespec curr_time;
	clock_gettime(CLOCK_MONOTONIC_RAW, &curr_time);
	srand(curr_time.tv_nsec);
}


void RaftServiceImpl::HandleRequestVote(const uint64_t& req_term,
                                        const uint64_t& candidate_id,
                                        const uint64_t& last_log_index,
                                        const uint64_t& last_log_term,
                                        uint64_t *resp_term,
                                        bool_t *vote_granted,
                                        rrr::DeferredReply* defer) {
  /* Your code here */
 svr_-&gt;handle_request_vote(req_term, candidate_id, last_log_index, last_log_term, resp_term, vote_granted);
    Log_debug("%s got request vote handled for %d (success = %d)", svr_-&gt;server_info().c_str(), candidate_id, *vote_granted);
  defer-&gt;reply();
}

//void RaftServiceImpl::HandleAppendEntries(const MarshallDeputy& md_cmd,
//                                          bool_t *followerAppendOK,
//                                          rrr::DeferredReply* defer) {
//  /* Your code here */
//  std::shared_ptr&lt;Marshallable&gt; cmd = const_cast&lt;MarshallDeputy&&gt;(md_cmd).sp_data_;
//  *followerAppendOK = false;
//  defer-&gt;reply();
//}
void RaftServiceImpl::HandleAppendEntries(const uint64_t &req_term, const uint64_t &leader_id,
                                          const uint64_t &prev_log_index, const uint64_t &prev_log_term,
                                          const janus::MarshallDeputy &cmd,const uint64_t &cmd_term, const uint64_t &leader_commit,
                                          uint64_t *resp_term, int8_t *success, rrr::DeferredReply *defer) {
  Log_debug("%s got append entries request from %d", svr_-&gt;server_info().c_str(), leader_id);
<A NAME="1"></A><FONT color = #00FF00><A HREF="match138-0.html#1" TARGET="0"><IMG SRC="../../../bitmaps/tm_1_9.gif" ALT="other" BORDER="0" ALIGN=left></A>

  std::shared_ptr&lt;Marshallable&gt; m_cmd = const_cast&lt;MarshallDeputy&&gt;(cmd).sp_data_;
  svr_-&gt;handle_append_entries(req_term, leader_id, prev_log_index, prev_log_term, m_cmd, cmd_term, leader_commit, resp_term, success);
</FONT>  Log_debug("%s got append entries request handled for %d (success = %d)", svr_-&gt;server_info().c_str(), leader_id, *success);
  defer-&gt;reply();
}

//void RaftServiceImpl::HandleEmptyAppendEntries(const uint64_t &req_term, const uint64_t &candidate_id,
//                                               uint64_t *resp_term, int8_t *append_ok, rrr::DeferredReply *defer) {
//    svr_-&gt;handle_heartbeat(req_term, candidate_id, resp_term, append_ok);
//    defer-&gt;reply();
//}
void RaftServiceImpl::HandleEmptyAppendEntries(const uint64_t &req_term, const uint64_t &leader_id,
                                               const uint64_t &prev_log_index, const uint64_t &prev_log_term,
<A NAME="0"></A><FONT color = #FF0000><A HREF="match138-0.html#0" TARGET="0"><IMG SRC="../../../bitmaps/tm_0_11.gif" ALT="other" BORDER="0" ALIGN=left></A>

                                               const uint64_t &leader_commit, uint64_t *resp_term, int8_t *append_ok,
                                               rrr::DeferredReply *defer) {
    svr_-&gt;handle_heartbeat(req_term, leader_id, prev_log_index, prev_log_term, leader_commit, resp_term, append_ok);
    defer-&gt;reply();
}

void RaftServiceImpl::HandleHelloRpc(const string& req,
</FONT>                                     string* res,
                                     rrr::DeferredReply* defer) {
  /* Your code here */
  Log_info("receive an rpc: %s", req.c_str());
  *res = "world";
  defer-&gt;reply();
}

} // namespace janus;
</PRE>
</PRE>
</BODY>
</HTML>
