<HTML>
<HEAD>
<TITLE>./github-lab2/dslabs-cpp-digaru19/src/kv/server.h</TITLE>
</HEAD>
<BODY BGCOLOR=white>
<HR>
./github-lab2/dslabs-cpp-digaru19/src/kv/server.h<p><PRE>

#pragma once

#include "../deptran/__dep__.h"
#include "../deptran/marshallable.h"
#include "../deptran/communicator.h"
#include "../deptran/raft/server.h"

namespace janus {
class RaftServer;

const int KV_SUCCESS = 0;
const int KV_TIMEOUT = 1;
const int KV_NOTLEADER = 2;

class MultiStringMarshallable : public Marshallable {
 public:
  MultiStringMarshallable() : Marshallable(MarshallDeputy::CMD_MULTI_STRING) {} 
  vector&lt;string&gt; data_{};
  Marshal& ToMarshal(Marshal& m) const override {
    int32_t sz = data_.size();
    m &lt;&lt; sz;
    for (auto& str : data_) {
      m &lt;&lt; str;
    }
    return m;
  }

  Marshal& FromMarshal(Marshal& m) override {
    int32_t sz;
    m &gt;&gt; sz;
    data_.resize(sz, "");
    for (auto& str : data_) {
      string s;
      m &gt;&gt; s;
      Log_debug(s.c_str());
      str = s;
    }
    return m;
  }
};

class KvClient;
class KvServer {
<A NAME="0"></A><FONT color = #FF0000><A HREF="match123-1.html#0" TARGET="1"><IMG SRC="../../../bitmaps/tm_0_23.gif" ALT="other" BORDER="0" ALIGN=left></A>

 public:

  shared_ptr&lt;TxLogServer&gt; sp_log_svr_; 
  int64_t op_id_cnt_ = 0;
  uint32_t cli_cnt_ = 0;
  Communicator* commo_{nullptr};

  /* add your variables here */
  std::map&lt;string, string&gt; kvStore;
  std::map&lt;string, shared_ptr&lt;IntEvent&gt; &gt; eventStore;

  RaftServer& GetRaftServer() {
    auto p = dynamic_pointer_cast&lt;RaftServer&gt;(sp_log_svr_);
    verify(p != nullptr);
</FONT>    return *p;
  }

  int64_t GetNextOpId();

  int Put(const uint64_t& op_id,
          const string& k,
          const string& v);

  int Append(const uint64_t& op_id, 
             const string& k,
             const string& v);

  int Get(const uint64_t& op_id, 
          const string& k,
          string* v);

  void OnNextCommand(Marshallable& m);

  shared_ptr&lt;KvClient&gt; CreateClient();
};

}; // namespace janus</PRE>
</PRE>
</BODY>
</HTML>
